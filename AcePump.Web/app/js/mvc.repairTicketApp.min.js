!function(){"use strict";angular.module("soris.ui.components",["kendo.directives"]).value("kendo",kendo).value("$",jQuery)}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(b){j()&&b.wrapper.find(".k-i-"+q).addClass("k-si-minus").click(function(c){var d=a("[srs-desktop]").scope();d.ctrl.hideElement(b.element.closest(".k-window")),d.$digest(),c.preventDefault()})}function i(a){j()&&!a.modal&&(a.actions||(a.actions=["Close"]),a.actions.unshift(q))}function j(){return a("[srs-desktop]").length>0}function k(b){var c=a("<div>");c.append(a("<div>").addClass("container-fluid").append(a("<p>").text(b.message)).append(a("<form>").addClass("form-horizontal").attr("name","frm").attr("srs-use-bootstrap-validation-classes","true").attr("ng-submit","frm.$valid && window.complete()")));var d={},e=c.find("form");for(var f in b.fields)e.append(a("<div>").addClass("form-group").append(a("<label>").addClass("col-md-4 control-label").text(b.fields[f].label)).append(a("<div>").addClass("col-md-8").append(a("<input>").addClass("form-control").attr("type","text").attr("ng-model","fields."+f)))),d[f]=b.fields[f].value;e.append(a('<div class="form-group"><div class="col-md-offset-4 col-md-8"><button class="btn btn-primary"><span class="fa fa-check"></span> {{ ::localize.Lbl_OK }}</button> <button class="btn btn-default" type="button" ng-click="window.close()"><span class="fa fa-ban"></span> {{ ::localize.Lbl_Cancel }}</button></div></div>'));var g=r.open({modal:!0,scopeParams:{fields:d},template:c.html(),title:b.title});return g.whenCompleted().then(function(){return d})}function l(a){function b(b,c){var d={width:b.options.width,height:b.options.height,position:{top:b.options.position.top,left:b.options.position.left}};"up"===c?(d.height=g.innerHeight/2-a,d.position.top=e):(d.height=g.innerHeight/2-a,d.position.top=g.innerHeight/2+e),d.width?d.position.left=g.innerWidth/2-d.width/2+a/2:(d.width=g.innerWidth-a,d.position.left=e),b.setOptions(d),h(b)}if(3!==arguments.length)throw new Error("multiCenter only supports two windows");var c=arguments[1],d=arguments[2],e=a/2;b(c.kendoWindow,"up"),b(d.kendoWindow,"down")}function m(a){a=angular.extend({},a),a.title||(a.title="Message");var d=n(a);i(a);var g=s.create(a);return d.scope.window=new p(g,d.scope),f.when().then(function(){return a.template?a.template:e(d.url)}).then(function(a){g.content(a),d.cssClass&&g.element.closest(".k-window").addClass(d.cssClass),d.controller&&c(d.controller,{$scope:d.scope}),b(g.element)(d.scope),h(g),g.open().center()}),d.scope.window}function n(a){var b={};return b.scope=d.$new(),angular.extend(b.scope,a.scopeParams),delete a.scopeParams,b.url=a.url,delete a.url,b.cssClass=a.cssClass,delete a.cssClass,b.controller=a.controller,delete a.controller,b}function o(a){s=a}function p(a,b){this.kendoWindow=a,this.scope=b,this.init()}var q="srs-minimize",r={CLOSE_REASON:{CANCEL:1,COMPLETE:2},KendoWindowWrapper:p,modalInput:k,multiCenter:l,open:m,setCreateWindowFactory:o},s={create:function(b){return b=angular.extend(b||{},{visible:!1}),a("<div>").appendTo(a("body")).kendoWindow(b).data("kendoWindow")}};return p.prototype.center=function(){this.kendoWindow.center()},p.prototype.cancel=function(){this.close(r.CLOSE_REASON.CANCEL)},p.prototype.close=function(a,b){this._isRunFlags._finalizePromises||this._finalizePromises(a,b),this._isRunFlags._closeKendoWindow||this._closeKendoWindow(),this._isRunFlags._cleanup||this._cleanup()},p.prototype._closeKendoWindow=function(){this._isRunFlags._closeKendoWindow=!0,this.kendoWindow.close()},p.prototype._cleanup=function(){this._isRunFlags._cleanup=!0,this.scope.$destroy(),this.kendoWindow.element.remove(),this.kendoWindow.destroy()},p.prototype.complete=function(a){this.close(r.CLOSE_REASON.COMPLETE,a)},p.prototype._finalizePromises=function(a,b){this._isRunFlags._finalizePromises=!0,this._deferreds.whenClosed.resolve(b),a===r.CLOSE_REASON.CANCEL?this._deferreds.whenCompleted.reject():a===r.CLOSE_REASON.COMPLETE?this._deferreds.whenCompleted.resolve(b):this._deferreds.whenCompleted.reject("UNKNOWN CLOSE REASON: "+a)},p.prototype.init=function(){var a=this;a._deferreds={whenClosed:f.defer(),whenCompleted:f.defer(),whenOpened:f.defer()},a._isRunFlags={_cleanup:!1,_closeKendoWindow:!1,_finalizePromises:!1},a.kendoWindow.bind("close",function(){a._closeKendoWindow._isRun=!0,a.close(r.CLOSE_REASON.CANCEL)}),a.kendoWindow.bind("open",function(){a._deferreds.whenOpened.resolve()})},p.prototype.whenClosed=function(){return this._deferreds.whenClosed.promise},p.prototype.whenCompleted=function(){return this._deferreds.whenCompleted.promise},p.prototype.whenOpened=function(){return this._deferreds.whenOpened.promise},r}angular.module("soris.ui.components").factory("kendoWindowService",a),a.$inject=["$","$compile","$controller","$rootScope","$templateRequest","$q","$window"]}(),function(){"use strict";function a(a){function b(b,c,d){"static"===c.css("position")&&c.css("position","relative"),b.$watch(d.srsLoading,function(b){a.ui.progress(c,b)})}var c={link:b,restrict:"A"};return c}angular.module("soris.ui.components").directive("srsLoading",a),a.$inject=["kendo"]}(),function(){"use strict";angular.module("acePump.core",["kendo.directives","soris.ui.components","ngCookies"]),angular.module("acePump.core").value("kendo",kendo)}(),function(){"use strict";function a(a){a.errorOnUnhandledRejections&&a.errorOnUnhandledRejections(!1)}angular.module("acePump.core").config(a),a.$inject=["$qProvider"]}(),function(){"use strict";function a(a){function b(a){return{request:function(b){var c=a.get("webapitoken");return void 0!==c&&(b.headers=b.headers||{},b.headers.Authorization="Bearer "+c),b}}}a.interceptors.push(b),b.$inject=["$cookies"]}angular.module("acePump.core").config(a),a.$inject=["$httpProvider"]}(),function(){"use strict";angular.module("acePump.core").filter("percent",["$filter",function(a){var b=a("number");return function(a){return b(100*a)+"%"}}])}(),function(){"use strict";function a(a){function b(a){a.ok=function(){a._closeDialog(),a._broadcastModalSpecificEvent("ok")},a.cancel=function(){a._closeDialog(),a._broadcastModalSpecificEvent("cancel")},a._closeDialog=function(){a.visible=!1},a._broadcastModalSpecificEvent=function(b){var c="modalService."+b+"."+a.modalId;a.$emit(c)},a.visible=!1}function c(b,c,d,e,f){function g(){var b=c.find(".s-modal-container"),d=angular.element(a).height(),e=b.height(),f=(d-e)/2;b.css("margin-top",f)}c.find(".s-modal-content").append(f());var h="modalService.open."+b.modalId;b.$on(h,function(a,c){b.visible=!0,g()}),angular.element(a).on("resize",g),g()}var d={restrict:"E",scope:{title:"@",okText:"@",cancelText:"@",modalId:"@"},template:'<div class="s-modal-backdrop" ng-show="visible"><div class="s-modal-container" ng-show="visible"><div class="s-modal-title-bar">{{title}}</div><div class="s-modal-content"></div><div class="s-modal-buttons"><button ng-click="ok()" type="button">{{okText}}</button><button ng-click="cancel()" type="button">{{cancelText}}</button></div></div></div>',transclude:!0,link:c,controller:b};return b.$inject=["$scope"],c.$inject=["$scope","elem","attrs","controller","$transclude"],d}angular.module("acePump.core").directive("modalDialog",a),a.$inject=["$window"]}(),function(){"use strict";function a(){function a(a,b,c){var d=48;b.on("keyup",function(a){if(!(a.which<d)){var e=b.val().length,f=parseInt(c.maxlength);if(e===f){var g=$("input[type=text]"),h=g.index(a.target),i=h+1,j=$("input[type=text]:nth("+i+")");j.focus()}}})}var b={restrict:"A",link:a};return a.$inject=["$scope","elem","attrs"],b}angular.module("acePump.core").directive("autoAdvance",a)}(),function(){"use strict";function a(){function a(a,b,d,e){b.on("change",function(a){for(var f=d.maxlength,g=b.val();g.length<f;)g+=c;e.$setViewValue(g),e.$render()})}var b={restrict:"A",link:a,require:"ngModel"},c=" ";return b}angular.module("acePump.core").directive("padInput",a),a.$inject=[]}(),function(){"use strict";function a(){function a(a,b,c){b.on("focus",function(a){a.target.select()})}var b={restrict:"A",link:a};return b}angular.module("acePump.core").directive("selectOnClick",a),a.$inject=[]}(),function(){"use strict";angular.module("acePump.core").service("modalService",["$rootScope","$q",function(a,b){function c(a){this.id=a,this.init()}function d(a){return a in f||(f[a]=new c(a)),f[a]}var e={OPEN:"MODAL_DIALOG_STATE_OPEN",CLOSED:"MODAL_DIALOG_STATE_CLOSED"};c.prototype.init=function(){this._initDeferred();var a=this;this._listenForModalSpecificEvent("ok",function(){a.ok()}),this._listenForModalSpecificEvent("cancel",function(){a.cancel()}),this.state=e.CLOSED},c.prototype._initDeferred=function(){function a(c,d){var e=b.defer();e.promise["finally"](function(){a(c,d)}),c[d]=e}a(this,"_deferred")},c.prototype.then=function(a,b){this._deferred.promise.then(a,b)},c.prototype.open=function(a){this.state!==e.OPEN&&(this.state=e.OPEN,this._broadcastModalSpecificEvent("open",a))},c.prototype.close=function(){this.state=e.CLOSED,this._deferred.reject("closed"),this._broadcastModalSpecificEvent("close")},c.prototype.ok=function(){this.state=e.CLOSED,this._deferred.resolve("ok")},c.prototype.cancel=function(){this.state=e.CLOSED,this._deferred.resolve("cancel")},c.prototype._broadcastModalSpecificEvent=function(b,c){var d=this._getModalSpecificEventName(b);"undefined"==typeof c?a.$broadcast(d):a.$broadcast(d,c)},c.prototype._listenForModalSpecificEvent=function(b,c){var d=this._getModalSpecificEventName(b);a.$on(d,c)},c.prototype._getModalSpecificEventName=function(a){return"modalService."+a+"."+this.id};var f={};return{getModal:function(a){return d(a)}}}])}(),function(){"use strict";function a(){function a(a){var b="";for(var c in a)a.hasOwnProperty(c)&&(b+=a[c].join(""));return b}function b(a,b,c){var d,e,f;return void 0!==b&&""!==b&&30===b.length&&(d=b.length,a=b+a.substring(d,a.length)),void 0!==c&&""!==c&&72===c.length&&(e=90,d=e+c.length,f=a.substring(0,e),a=f+c+a.substring(d,a.length)),a}function c(a,c,e){a=b(a,c,e);var f=new d(a),g={},h=0;for(g.PlungerOrig=[],h=0;h<15;h++)g.PlungerOrig[h]=f.next().value;for(g.PlungerWearRepaired=[],h=0;h<15;h++)g.PlungerWearRepaired[h]=f.next().value;for(g.PlungerOut=[],h=0;h<15;h++)g.PlungerOut[h]=f.next().value;for(g.BarrelOrig=[],h=0;h<36;h++)g.BarrelOrig[h]=f.next().value;for(g.BarrelWearRepaired=[],h=0;h<36;h++)g.BarrelWearRepaired[h]=f.next().value;for(g.BarrelOut=[],h=0;h<36;h++)g.BarrelOut[h]=f.next().value;return g}function d(a){var b=0;return{next:function(){if(b<a.length){var c={value:a.substring(b,b+2)};return b+=2,c}return null}}}var e={serialize:a,deserialize:c,makeDeserializeIterator:d};return e}angular.module("acePump.core").service("plungerBarrelWearSerializationService",a)}(),function(){"use strict";function a(a,b){function c(b,c,d){return a({method:"POST",url:b,responseType:"json",data:{id:c,customerID:d}}).then(function(a){return a.data.Available})}function d(c,d){return a({method:"POST",responseType:"json",url:c,data:{model:d,useInventory:!d.ReplacedWithInventoryPartID}}).then(function(a){return a.data.Success?{replacedWithInventoryPartID:a.data.ReplacedWithInventoryPartID,availableInInventory:a.data.AvailableInInventory}:b.reject(a.data.Errors)})}function e(c,d,e){return b.when().then(function(){for(var b=[],f=0;f<e.length;f++)"Replace"!==e[f].Result&&"Convert"!==e[f].Result||(b[f]=e[f].PartReplacedID);return b.length>0?a({method:"POST",responseType:"json",url:c,data:{partTemplateIDs:b,customerId:d}}).then(function(a){return a.data}):[]})}function f(c,d,e,f){return b.when().then(function(){return a({method:"POST",responseType:"json",url:c,data:{pumpID:d,customerID:e,currentTicketDate:f}}).then(function(a){return a})})["catch"](function(a){return[]})}var g={checkAvailability:c,usePartFromInventory:d,checkAvailabilityForInspections:e,loadOriginalPartsCustomerOwned:f};return g}angular.module("acePump.core").service("inventoryService",a),a.$inject=["$http","$q"]}(),function(){"use strict";function a(a,b){function c(c){return b.confirm(c)?a.resolve():a.reject()}var d={confirm:c};return d}angular.module("acePump.core").service("util",a),a.$inject=["$q","$window"]}(),function(){"use strict";angular.module("acePump.backOffice",["acePump.core"])}(),function(){"use strict";angular.module("acePump",["acePump.backOffice"])}(),function(){"use strict";function a(a){function b(b){b.searchTextChanged_Internal=function(){null!==b._searchTimeout&&a.cancel(b._searchTimeout),b._searchTimeout=a(b.runSearch,100,!1)},b.runSearch=function(){var a=b.getSearchText();return b._kendoComboBox.options.minLength>a.length?(b._kendoComboBox.dataSource.data([]),void b._kendoComboBox.close()):void(b._reqInProgress||(b._setReqInProgress(),b.$parent.searchTextChanged(a).then(function(a){b._clearReqInProgress(),b._kendoComboBox.dataSource.data(a),a.length>0&&b._kendoComboBox.open()})))},b._setReqInProgress=function(){b._reqInProgress=!0;var a=b._wrapperElement.find(".k-select");kendo.ui.progress(a,!0),a.find(".k-loading-image").css("background-size","contain")},b._clearReqInProgress=function(){b._reqInProgress=!1;var a=b._wrapperElement.find(".k-select");kendo.ui.progress(a,!1)},b.getSearchText=function(){return b._kendoVisibleInput.val()}}function c(a,b,c){a._wrapperElement=b,a._searchTimeout=null,a._kendoComboBox=b.find(".k-combobox select").data("handler"),a._kendoVisibleInput=b.find(".k-combobox .k-input")}var d={priority:-100,restrict:"E",transclude:!0,scope:{},template:'<span class="kendo-combo-workaround-container" ng-keyup="searchTextChanged_Internal()"><div ng-transclude></div></span>',link:c,controller:b};return b.$inject=["$scope"],c.$inject=["scope","elem","attrs"],d}angular.module("acePump.core").directive("kendoComboDatasourceWorkaround",a),a.$inject=["$timeout"]}(),function(){"use strict";function a(a,b,c,d){function e(a){h.originalPlungerBarrelWear=a.originalPlungerBarrelWear,h.readUrl=a.readUrl,h.updateUrl=a.updateUrl,h.deliveryTicketID=a.deliveryTicketID,null!==h.originalPlungerBarrelWear&&""!==h.originalPlungerBarrelWear||(h.originalPlungerBarrelWear=""+f(306));var c=b.deserialize(h.originalPlungerBarrelWear,a.plungerOrigFromPreviousOut,a.barrelOrigFromPreviousOut);h.PlungerOrig=c.PlungerOrig,h.PlungerWearRepaired=c.PlungerWearRepaired,h.PlungerOut=c.PlungerOut,h.BarrelOrig=c.BarrelOrig,h.BarrelWearRepaired=c.BarrelWearRepaired,h.BarrelOut=c.BarrelOut}function f(a){var b=new Array(a+1);return b.join(" ")}function g(){var c={PlungerOrig:h.PlungerOrig,PlungerWearRepaired:h.PlungerWearRepaired,PlungerOut:h.PlungerOut,BarrelOrig:h.BarrelOrig,BarrelWearRepaired:h.BarrelWearRepaired,BarrelOut:h.BarrelOut},e=b.serialize(c);return a({method:"POST",url:h.updateUrl,responseType:"json",data:{id:h.deliveryTicketID,plungerBarrelWear:e}}).then(function(a){d.frmPlungerWear&&d.frmPlungerWear.$setPristine()})["catch"](function(a){$window.alert("Was not able to update the plunger barrel wear!  Please try again.\n"+a.status+": "+a.statusText)})}var h=this;h.PlungerOrig=[],h.PlungerWearRepaired=[],h.PlungerOut=[],h.BarrelOrig=[],h.BarrelWearRepaired=[],h.BarrelOut=[],h.init=e,h.save=g}angular.module("acePump.backOffice").controller("PlungerBarrelWearController",a),a.$inject=["$http","plungerBarrelWearSerializationService","$q","$scope"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(a,b){function c(f){var g=a(f);g?e.resolve(f):d.when(b(f)).then(function(a){c(a)})["catch"](function(a){e.reject(a)})}var e=d.defer();return c(),e.promise}e.CONSTANTS={ERROR_HANDLED:"$scope.ERROR_HANDLED"},e.grid_Error=function(a){if(a.errors){var b="";for(var c in a.errors){var d=a.errors[c];if("errors"in d)for(var f=0;f<d.errors.length;f++)b+=c+": "+d.errors[f]+"\n"}e.errorMessage=b,e._revertPartInspectionValues(a.model)}},e.validateAllItemsMarked=function(){for(var a=!0,b=0;b<e.inspections.length;b++)e.inspections[b].Result||(a=!1,e.inspections[b].updateFailed=!0);return a?e.saveAll():(e.alert("You must mark all parts on the repair ticket before you can complete it."),d.reject())},e.validateAndPost=function(){e.validateAllItemsMarked().then(function(){var a=angular.element("form[name='inspectionForm']");a.submit()})},e.saveAll=function(){for(var a=[],b=0;b<e.inspections.length;b++){var c=e.inspections[b];c._markCompletedPromise&&a.push(c._markCompletedPromise),e.inspections[b].inEditMode&&(e._prepareForSave(e.inspections[b]),c._editDeferred.resolve(),delete c._editDeferred)}return d.all(a)},e.markPart=function(a,b){var c=d.defer();a._markCompletedPromise=c.promise,d.when().then(function(){if(a.IsSplitAssembly)return e.unsplitAssembly(a)}).then(function(){e._setInspectionValuesByMark(a,b)}).then(function(){if(e._shouldSuggestAssemblySplit(a,b))return e.suggestReplaceAssembly(a)["catch"](function(){return c.resolve(),delete a._markCompletedPromise,d.reject()})}).then(function(){return e._shouldAllowEditingBeforePostUpdate(a)?e._runAllowEditAndPostLoop(a)["catch"](function(a){return"cancel"===a?(c.resolve("cancel"),d.reject(e.CONSTANTS.ERROR_HANDLED)):d.reject(a)}):e.postInspectionUpdate(a)["catch"](function(b){return e._revertPartInspectionValues(a),d.reject(b)})}).then(function(){return e.checkAvailabilityInInventory(a)}).then(function(){a.updateFailed=!1,c.resolve(),delete a._markCompletedPromise})["catch"](function(a){a!==e.CONSTANTS.ERROR_HANDLED&&(c.reject(),console.log("Unhandled error in markPart: "+a))})},e.checkAvailabilityInInventory=function(a){return d.when().then(function(){if(e.serverVars.customerUsesInventory){var c=e.serverVars.checkAvailabilityInInventoryUrl,d=(a.PartReplacedID,e.serverVars.customerID);return!(!e.serverVars.canModifyInventory||!a.PartReplacedID)&&b.checkAvailability(c,a.PartReplacedID,d)}return!1}).then(function(b){a.AvailableInInventory=b,a.showInventoryButton=e.showInventoryButton(a)})},e._runAllowEditAndPostLoop=function(a){var b={updateSucceeded:!1};return i(function(){return b.updateSucceeded},function(c){return e.allowEditing(a)["catch"](function(a){return a!==e.CONSTANTS.ERROR_HANDLED?d.reject(a):d.resolve()}).then(function(){return e.postInspectionUpdate(a).then(function(){b.updateSucceeded=!0,a.updateFailed=!1})["catch"](function(b){return a.updateFailed=!0,d.resolve()})})})},e._shouldSuggestAssemblySplit=function(a,b){return"Replace"===b&&"ROUT/MAINT"!==a.ReasonRepaired&&a.CanBeRepresentedAsAssembly},e._shouldAllowEditingBeforePostUpdate=function(a){return"Replace"===a.Result&&"ROUT/MAINT"!==a.ReasonRepaired||"Convert"===a.Result},e._revertPartInspectionValues=function(a){"undefined"!=typeof a._previousInspectionValues&&(e._copyPartInspectionValues(a._previousInspectionValues,a),delete a._previousInspectionValues)},e._copyPartInspectionValues=function(a,b){b.Result=a.Result,b.ReasonRepaired=a.ReasonRepaired,b.ReplacementQuantity=a.ReplacementQuantity,b.ReplacementPartTemplateNumber=a.ReplacementPartTemplateNumber,b.PartReplacedID=a.PartReplacedID},e.postInspectionUpdate=function(b){return b.serverOperationInProgress=!0,a({method:"POST",url:e.serverVars.updateUrl,responseType:"json",data:b}).then(function(a){if(b.serverOperationInProgress=!1,b.ReplacedWithInventoryPartID=null,!e._handleInspectionPostErrors(a.data,b))return d.reject(e.CONSTANTS.ERROR_HANDLED)})},e.postInspectionDelete=function(b){return b.serverOperationInProgress=!0,a({method:"POST",url:e.serverVars.removeUrl,responseType:"json",data:{PartInspectionID:b.PartInspectionID}}).then(function(a){return b.serverOperationInProgress=!1,e._handleInspectionPostErrors(a.data,b)?void("Changes"in a.data&&"Removed"in a.data.Changes&&a.data.Changes.Removed.length>0&&e._removeInspectionsFromDisplay(a.data.Changes.Removed)):(e._revertPartInspectionValues(b),d.reject(e.CONSTANTS.ERROR_HANDLED))})},e.alert=function(a){h.alert(a)},e._removeInspectionsFromDisplay=function(a){for(var b=0;b<e.inspections.length;b++)for(var c=0;c<a.length;c++)e.inspections[b].PartInspectionID===a[c].PartInspectionID&&(e.inspections.splice(b,1),b--,a.splice(c,1),c=a.length)},e._handleInspectionPostErrors=function(a,b){if("Errors"in a&&null!==a.Errors){var c="Could not save "+b.OriginalPartTemplateNumber+"\n";for(var d in a.Errors)for(var f=a.Errors[d].errors,g=0;g<f.length;g++)c+="\t- "+d+": "+f[g]+"\n";return e.alert(c),!1}return!0},e._setInspectionValuesByMark=function(a,b){switch(a._previousInspectionValues={Result:a.Result,ReasonRepaired:a.ReasonRepaired,ReplacementQuantity:a.ReplacementQuantity,ReplacementPartTemplateNumber:a.ReplacementPartTemplateNumber,PartReplacedID:a.PartReplacedID},b){case"OK":a.Result="OK",a.ReasonRepaired=null,a.ReplacementPartTemplateNumber="",a.ReplacementQuantity=null,a.PartReplacedID=null,a.ReplacedWithInventoryPartID=null;break;case"NA":a.Result="N/A",a.ReasonRepaired="Did not inspect",a.ReplacementPartTemplateNumber="",a.ReplacementQuantity=null,a.PartReplacedID=null,a.ReplacedWithInventoryPartID=null;break;case"Maintenance":a.Result="Replace",a.ReasonRepaired="ROUT/MAINT",a.ReplacementPartTemplateNumber=a.OriginalPartTemplateNumber,a.ReplacementQuantity=a.Quantity,a.PartReplacedID=a.OriginalPartTemplateID;break;case"Convert":a.Result="Convert",a.ReplacementQuantity=a.Quantity,a.ReplacementPartTemplateNumber="",a.PartReplacedID=null;break;case"Replace":a.Result="Replace",a.ReasonRepaired=null,a.ReplacementPartTemplateNumber=a.OriginalPartTemplateNumber,a.ReplacementQuantity=a.Quantity,a.PartReplacedID=a.OriginalPartTemplateID;break;default:throw new Error("Unknown mark: "+b)}},e.unsplitAssembly=function(a){a.IsSplitAssembly=!1,a.serverOperationInProgress=!0;for(var b=[],c=0;c<e.inspections.length;c++){var f=e.inspections[c];if(f.ParentAssemblyID===a.PartInspectionID){var g=e.deleteInspection(f,c,!0);b.push(g)}}var h=e.postInspectionUpdate(a);b.push(h);var i=d.all(b).then(function(){a.serverOperationInProgress=!1});return i},e.deleteInspection=function(a,b,c){return c===!0||h.confirm("Are you sure you want to delete this record?")?("undefined"!=typeof b&&null!==b||(b=e._getInpsectionIndex(a)),a=e.inspections[b],e.postInspectionDelete(a).then(function(){e.inspections[b]!==a&&(b=e._getInpsectionIndex(a)),e.inspections.splice(b,1)})):d.reject("cancelled")},e._getInpsectionIndex=function(a){for(var b=0;b<e.inspections.length;b++)if(e.inspections[b].PartInspectionID===a.PartInspectionID)return b;throw new Error("Could not find matching inspection")},e.suggestReplaceAssembly=function(a){var b=d.defer(),f=c.getModal("suggest-replace-assembly");return f.open(),f.then(function(c){"ok"===c?b.resolve():"cancel"===c&&(b.reject(e.CONSTANTS.ERROR_HANDLED),e._setInspectionValuesByMark(a,"OK"),a.IsSplitAssembly=!0,e.splitAssembly(a))},function(a){b.reject(a)}),b.promise},e.splitAssembly=function(b){b.serverOperationInProgress=!0;var c=a({method:"POST",responseType:"json",url:e.serverVars.splitAssmUrl,data:{partInspectionId:b.PartInspectionID}}).then(function(a){e._updateInspectionSortOrdersAndAddNew(a.data.Data),b.serverOperationInProgress=!1});return c},e._updateInspectionSortOrdersAndAddNew=function(a){var b=function(a,b){return a.PartInspectionID>b.PartInspectionID?1:-1},c=e.inspections.slice();a=a.sort(b),c=c.sort(b);for(var d=0,f=0;f<a.length;f++){var g=c[d],h=a[f];d>=c.length||c[d].PartInspectionID!==a[f].PartInspectionID?e.inspections.push(h):(g.SortOrder=h.SortOrder,d++)}},e.syncInspectionOrder=function(){a({url:e.serverVars.syncInspectionOrderUrl,method:"POST",data:{id:e.serverVars.deliveryTicketID}}).then(function(a){e.inspections=a.data})},e.allowEditing=function(a){var b=d.defer();return b.promise["finally"](function(){a.editReplacementPartTemplateNumber=!1,a.inEditMode=!1,delete a._editDeferred}),a.inEditMode=!0,"Convert"===a.Result&&(a.editReplacementPartTemplateNumber=!0),a.showInventoryButton=e.showInventoryButton(a),a._editDeferred=b,b.promise},e.cancelEdit=function(a){e._verifyInEditMode(a),a._editDeferred.reject("cancel"),e._revertPartInspectionValues(a)},e.saveEdit=function(a){e._verifyInEditMode(a),e._prepareForSave(a),a._editDeferred.resolve()},e._prepareForSave=function(a){a.editReplacementPartTemplateNumber&&"ReplacementPartInfo"in a&&(a.ReplacementPartTemplateNumber=a.ReplacementPartInfo.PartTemplateNumber,a.PartReplacedID=a.ReplacementPartInfo.PartTemplateID)},e._verifyInEditMode=function(a){if(!a.inEditMode)throw new Error("not currently in edit mode!");if("undefined"==typeof a._editDeferred)throw new Error("missing deferred could not continue")},e.searchTextChanged=function(b){var c=d.defer();return a({url:e.serverVars.partsByNumberReadUrl,method:"POST",data:{text:b}}).then(function(a){c.resolve(a.data)}),c.promise},e.switchRepairMode=function(){return g.confirm("CAUTION: Switching to tear down will delete all inspections for this ticket. Are you sure you want to continue?").then(function(){return a({method:"POST",responseType:"json",url:e.serverVars.switchRepairModeUrl,data:{id:e.serverVars.deliveryTicketID}}).then(function(a){return a.data.Success?void h.location.assign(a.data.RedirectUrl):d.reject(a.data.Errors)})})["catch"](function(a){for(var b="",c=0;c<a.length;c++)b=a[c].ErrorMessage+"/n";h.alert(b)})},e.usePartFromInventory=function(a){var c=e.serverVars.updateUsingPartFromInventoryUrl;return b.usePartFromInventory(c,a).then(function(b){a.ReplacedWithInventoryPartID=b.replacedWithInventoryPartID,a.AvailableInInventory=b.availableInInventory})["catch"](function(b){for(var c="",d=0;d<b.length;d++)c=b[d].ErrorMessage+"\n";return h.alert(c),e.checkAvailabilityInInventory(a)})},e._shouldAllowUsingInventory=function(a){return"Replace"===a.Result||"Convert"===a.Result},e.showInventoryButton=function(a){var b=e.serverVars.canModifyInventory&&!a.CanBeRepresentedAsAssembly&&!a.HasParentAssembly&&!a.inEditMode&&(!!a.ReplacedWithInventoryPartID||e._shouldAllowUsingInventory(a)&&a.AvailableInInventory&&1===parseInt(a.ReplacementQuantity));return b},e.checkInventoryList=function(){var a=e.serverVars.checkInventoryListUrl,c=e.serverVars.customerID;return b.checkAvailabilityForInspections(a,c,e.inspections).then(function(a){for(var b=0;b<e.inspections.length;b++){for(var c=e.inspections[b],d=0;d<a.length;d++)a[d].PartTemplateID===c.PartReplacedID&&(c.AvailableInInventory=!0,d=a.length);c.showInventoryButton=e.showInventoryButton(c)}})},e.loadInspections=function(b){return a({method:"POST",responseType:"json",url:e.serverVars.readUrl,data:{id:b}}).then(function(a){e.inspections=a.data.Data})},e.loadReasonsRepaired=function(){return a({method:"POST",responseType:"json",url:e.serverVars.reasonRepairedListUrl}).then(function(a){e.reasonsRepaired=a.data})},e.loadPumpFailedTemplates=function(){return a({method:"POST",responseType:"json",url:e.serverVars.listTemplatesUrl}).then(function(a){if(e.templates=a.data,e.serverVars.pumpTemplateID)for(var b=0;b<e.templates.length;b++)e.serverVars.pumpTemplateID===e.templates[b].PumpTemplateId&&(e.selectedTemplate=e.templates[b],b=e.templates.length)})},e.loadTemplates=function(){return e.templatesLoaded?d.resolve():a({method:"POST",responseType:"json",url:e.serverVars.listTemplatesUrl}).then(function(a){if(e.templates=a.data,e.serverVars.pumpTemplateID)for(var b=0;b<e.templates.length;b++)e.serverVars.pumpTemplateID===e.templates[b].PumpTemplateId&&(e.selectedTemplate=e.templates[b],b=e.templates.length);e.templatesLoaded=!0})},e.showUpdateTemplateSelect=function(){e.templatesLoading=!0,e.loadTemplates().then(function(){e.updateTemplateSelectVisible=!0})["catch"](function(a){for(var b="",c=0;c<a.length;c++)b=a[c].ErrorMessage+"\n";h.alert(b)})["finally"](function(){e.templatesLoading=!1})},e.updateTemplate=function(){if(e.selectedTemplate.PumpTemplateId!==e.serverVars.pumpTemplateID)return g.confirm("WARNING: Changing this template number will erase the parts shown below and replace everything with new parts.  Are you sure you want to change the template number?").then(function(){return a({method:"POST",responseType:"json",url:e.serverVars.updateTemplateUrl,data:{deliveryTicketId:e.serverVars.deliveryTicketID,newTemplateId:e.selectedTemplate.PumpTemplateId}}).then(function(a){return a.data.Success?(e.serverVars.pumpTemplateID=e.selectedTemplate.PumpTemplateId,e.serverVars.pumpFailedSpecSummary=a.data.PumpFailedConciseSpecSummary,e.updateTemplateSelectVisible=!1,e.refreshInspections()):d.reject(a.data.Errors)})})["catch"](function(a){for(var b="",c=0;c<a.length;c++)b=a[c].ErrorMessage+"\n";h.alert(b)})},e.loadOriginalPartCustomerOwned=function(a,c,d){var f=e.serverVars.listPartsInUseForPumpUrl;return b.loadOriginalPartsCustomerOwned(f,a,c,d).then(function(a){for(var b=0;b<e.inspections.length;b++)for(var c=e.inspections[b],d=0;d<a.data.length;d++)a.data[d].TemplatePartDefID===c.TemplatePartDefID&&(null!==a.data[d].ReplacedWithInventoryPartID&&(c.OriginalCustomerOwnedPartID=a.data[d].ReplacedWithInventoryPartID),d=a.data.length)})},e.refreshInspections=function(){return e.loadInspections(e.serverVars.deliveryTicketID).then(function(){if(e.serverVars.customerUsesInventory&&e.serverVars.canModifyInventory)return e.checkInventoryList()}).then(function(){if(e.serverVars.customerUsesInventory)return e.loadOriginalPartCustomerOwned(e.serverVars.pumpFailedID,e.serverVars.customerID,e.serverVars.currentTicketDate)})},function(){f(function(){e.refreshInspections(),e.serverVars.reasonRepairedListUrl&&e.loadReasonsRepaired()},0,!1)}()}angular.module("acePump.backOffice").controller("RepairTicketController",a),a.$inject=["$http","inventoryService","modalService","$q","$scope","$timeout","util","$window"]}();